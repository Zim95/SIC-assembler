Convert the pass1 and pass2 algorithms to functions.
